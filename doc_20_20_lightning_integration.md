---
layout: default
title: Integration
parent: Lightning Network
has_children: false
nav_order: 2
---

# Integration
{: .no_toc }
The web application is reliant on the Lightning Node for different activities including:
- Generating new invoices
- Checking if an invoice has been paid
- Send out withdrawals to authors

The developers of LND created an API that allows the interaction with their deamon from a variety of programming languages either by **REST** or **gRPC**. [gRPC](https://grpc.io/faq/) is a modern, open source remote procedure call framework developed by Google and is based on HTTP/2. Compared to REST it does not use text based JSON messages but strongly typed stub messages. Those stubs are binary based and allow bidirectional streaming. Furthermore there is a performance gain of using gRPC.

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---
## gRPC
When using gRPC, a service is defined independent of any programming language in so called protocol buffers. These are file which define the services and messages that can be used. The `.proto` file used for LND can be [found on Github](https://github.com/lightningnetwork/lnd/blob/master/lnrpc/rpc.proto).

To use those services within our PHP application we first needed to create the gRPC code from the proto file. [This guide](https://grpc.io/docs/quickstart/php/) shows how to obtain the PHP code. In the folder `/src/Lnrpc/` of our project the generated code can be inspected.

Each interaction with the gRPC interface requires a client instance. `/src/rpcclient/RpcClient.php` creates such an instance with the following code.
```php
protected function __construct($node)
{
    putenv('GRPC_SSL_CIPHER_SUITES=HIGH+ECDSA');
    $nd = new NodeDAO();
    $node = $nd->readActive();
    $ssl = $node["fld_node_tls"];
    $macaroon = hex2bin($node["fld_node_macaroon"]);
    $lndIp = $node["fld_node_ip"];
    $metadataCallback = function ($metadata) use ($macaroon) {
        return ['macaroon' => [bin2hex($macaroon)]];
    };
    try{
        self::$clientInstance = new LightningClient($lndIp, [
            'credentials' => ChannelCredentials::createSsl($ssl),
            'update_metadata' => $metadataCallback
        ]);
    } catch (Exception $e) {
        throw new Exception($e->getMessage());
        echo "something went wrong";
    }

}
```
`Node-IP`, `SSL certificat` and a `macaroon` are required to connect to the node. All this information is stored in the database (`$nd->readActive()` returns an entry of the active node set in `tbl_node`).

`Node-IP`: IP address where the node can be reached. In our case it is localhost:10009 since we forward traffic via SSH to the remote Raspberry Pi.

`SSL certificat`: A certificate which is generated by the Lightning node and has to be stored in plain text to the database.

`macaroon`: A special authentication file which grants certain privileges to the owner of the file. More details follow in the next sub chapter.

[A full documentation of the API can be found here.](https://api.lightning.community/#lnd-grpc-api-reference)

## Authentication

## Invoice generation

## Check for payments

## Withdrawal

### via Invoice

### via LNURL
check compatible wallets
